/*
 * MAL[MartinAlexandreLaurie]Ware program for project Gutenberg
 * choose a text
 * => add a style
 * => print!
 * */

source = "../examples/alice.htm"; // http://www.gutenberg.org/files/11/11-h/11-h.htm
//source = "http://www.gutenberg.org/files/31704/31704-h/31704-h.htm";
//source = "http://leyokki.org";

var result = '';
var nodeValues = [];

function loadDiv(source)
{
	// loading webpage from source URL
	$.get('php/grabber.php?url='+source,function(data){
		delHeaders(data);
	});
}

function delHeaders(data){
	var $page = $("#page"),
	isHead = false,
	html = $.parseHTML(data),
	nodeNames = [],
	scrolling = "",

	/* TO ADD SOME DAY */
	// compteur pour le nombre de paragraphes
	// idée: si nb_p est un nombre premier, ajoute une classe
	nb_p = 0;

	// parses elements of the page
	$.each(html,function(i,el){
		//scrolling pour jeter un oeil aux balises
		scrolling += el.nodeName+"\n";

		// It parses and keeps only h1, h2, h3, h4 and <p>
		// note: function deleted : prime
		if (el.nodeName == "H1") {
			nodeNames[i] = "<h1>"+el.innerHTML+"</h1>";
		} else if (el.nodeName == "H2") {
			nodeNames[i] = "<h2>"+el.innerHTML+"</h2>";
		} else if (el.nodeName == "H3") {
			nodeNames[i] = "<h3>"+el.innerHTML+"</h3>";
		} else if (el.nodeName == "H4") {
			nodeNames[i] = "<h4>"+el.innerHTML+"</h4>";
		} else if (el.nodeName == "#text" || el.nodeName == "PRE" || el.nodeName == "TITLE" || el.nodeName == "#comment") {
			var haveaniceday = true;
		} else {
			nodeNames[i] = "<p>"+el.innerHTML+"</p>";
		}
	});

	// cleaning nodes
	nodeNames.forEach(function(line,i){
	/*	if (cleaningLine(line) == " ") {
			console.log(line);
		}
		nodeNames[i] = cleaningLine(line);*/
	});

	// print the results
	$page.append(nodeNames.join(""))
		.appendTo($page);
	var wholePage = $page.html();
	wholePage = addLineReturn(wholePage);
	$page.replaceWith(wholePage);
	//console.log(wholePage);

}

// cleaning text :
// delete all the empty <p> (without anything or only with <br/>
function cleanText(text){
	for (var i = 0; i < page.length; i++) {
		if (page[i+1] == "<" && page[i+2] == "b" && page[i+3] == "r" && page[i+4] == ">") {
			i+=4;
		} else {
			newPage+=page[i];
		}
	}
};

// delete blank <p>
// not sure to use it now.
function cleaningLine(line){
	// FUNCTION NOT DONE:
	// NEED TO KNOW HOW TO CHECK <BR>
	shortline = "";
	var is_blank = true;
	// check line is a paragraph
	if (line[1] == "p") {
		for (var i = 3; i < line.length - 4; i++){
			if (line[i] == "<" && line[i+1] == "b" && line[i+2] == "r" << line[i+3] == ">") {
				i += 3;
				is_blank = true;
			} else if (line[i] == "/\w/g") {
				is_blank = false;
			}
		}
		if (is_blank) {
			console.log("blank line\n");
			return " ";
		}
	}
	 else {
		console.log("not a paragraph");
		shortline = line;
		$("#log").append(shortline);
	}
	return line;
}
// adding <hr> for every page
// before <h1> and after every 250 words.
function addLineReturn(page) {
	var max_words = 400;
	var count = 0;
	var is_title = false;
	var newPage = "";
	
	for (var i = 0; i < page.length; i++) {
		newPage+=page[i];
		if (page[i] == " " && page[i-1] != ">") {
		// Check if page is a space and the page before really is a page
			var patt = new RegExp(/\S/);
			var matchCaracter = patt.test(page[i-1]);
		//	console.log(page[i-1]);
			if (matchCaracter) {
//				console.log("match!");
				count++;
				if (count >= max_words) {
					console.log("new page! : ");
					newPage += "<hr>";
					count = 0;
				}
			}
		}
		if (page[i] == "<") {
			if ((page[i+1] == "h" || page[i+1] == "H") && (page[i+3] == ">")){
				count = 0;
			}
		}

	}
	return newPage;
}

// function to test if n is a prime number
// cf. http://www.javascripter.net/faq/numberisprime.htm
function isPrime3(n) {
	 if (isNaN(n) || !isFinite(n) || n%1 || n<2) return false; 
	  if (n%2==0) return (n==2);
	   if (n%3==0) return (n==3);
	    var m=Math.sqrt(n);
	     for (var i=5;i<=m;i+=6) {
		       if (n%i==0)     return false;
		         if (n%(i+2)==0) return false;
			  }
	      return true;
}

loadDiv(source);

// OLD NOTES

// conserver les <ol> pour garder les styles ? = $("<ol></ol>")
// weird stuff: anchors still works (for titles)
